### create_data_yaml.R #############################################################################
# Create a yaml file pointing to fastq or BAM files.
# Assumes input files were generated by OICR/TGL and follow standard file-name rules:
# FASTQ: TGL99_0001_Ov_P_PE_111_WG_230111_A00461_0461_BHFLYTDSX5_1_TGGACTCT-TCTTACGG_R2.fastq.gz
#	>> project_sample#_tissuetype_library#_seqtype_laneID_barcode_R{1|2}.fastq.gz	
# BAM: TGL99_0001_Ov_P_WG_ID-001-T.filter.deduped.recalibrated.bam
#	>> project_sample#_tissue_library#_seqtype_sampleID.filter.deduped.recalibrated.bam

### PREPARE SESSION ################################################################################
# import libraries
library(argparse);

# import command line arguments
parser <- ArgumentParser();

parser$add_argument('-d', '--directory', type = 'character', help = 'path to data directory');
parser$add_argument('-o', '--output', type = 'character', help = 'path to output file');
parser$add_argument('-t', '--file_type', type = 'character', help = 'either fastq or bam', default = 'fastq');

arguments <- parser$parse_args();

setwd(arguments$directory);

### MAIN ###########################################################################################
# initiate output file
write('---', file = arguments$output);

# find files and extract relevant information
if ('fastq' == arguments$file_type) {

	# find files
	fastqs <- list.files(
		pattern = 'fastq.gz$',
		recursive = TRUE,
		full.names = TRUE,
		path = getwd()
		);

	# extract one file per pair (assuming paired end)
	r1 <- fastqs[grepl('R1',fastqs)];

	# split into identifiers
	patient <- sapply(r1, function(i) { paste(unlist(strsplit(basename(i),'_'))[1:2], collapse = '_') } );
	sample_id <- sapply(r1, function(i) { paste(unlist(strsplit(basename(i),'_'))[1:4], collapse = '_') } );
	sample_type <- sapply(r1, function(i) { unlist(strsplit(basename(i),'_'))[4] } );
	lib_id <- sapply(r1, function(i) { paste(unlist(strsplit(basename(i),'_'))[1:7], collapse = '_') } );
	lane_id <- sapply(r1, function(i) { paste(unlist(strsplit(basename(i),'_'))[8:12], collapse = '_') } );

	# make a data frame
	df <- data.frame(
		Patient = patient,
		Sample = sample_id,
		Type = sample_type,
		Library = lib_id,
		Lane = lane_id,
		R1 = r1,
		R2 = gsub('R1','R2',r1)
		);

	} else if ('bam' == arguments$file_type) {

	# find files
	bams <- list.files(
		pattern = '.bam$',
		recursive = TRUE,
		full.names = TRUE,
		path = getwd()
		);

	# split into identifiers
	patient <- sapply(bams, function(i) { paste(unlist(strsplit(basename(i),'_'))[1:2], collapse = '_') } );
	sample_id <- sapply(bams, function(i) { paste(unlist(strsplit(basename(i),'_'))[1:4], collapse = '_') } );
	sample_type <- sapply(bams, function(i) { 
		tmp <- unlist(strsplit(basename(i),'_'))[4];
		type <- if ('R' == tmp) { 'normal' } else { 'tumour' }
		return(type);
		} );

	# make a data frame
	df <- data.frame(
		Patient = patient,
		Sample = sample_id,
		Type = sample_type,
		Library = NA,
		File = bams
		);
	}

# make sure data is sorted
df <- df[order(
	df$Patient,
	df$Sample,
	df$Type,
	df$Library
	),];

# for fastqs
if ('fastq' == arguments$file_type) {

	for (pat in unique(df$Patient)) {

		patient.data <- droplevels(df[which(df$Patient == pat),]);
		if (nrow(patient.data) == 0) { next; }

		write(paste0(pat,':'), file = arguments$output, append = TRUE);

		for (smp in unique(df[which(df$Patient == pat),]$Sample)) {

			sample.data <- droplevels(patient.data[which(patient.data$Sample == smp),]);
			if (nrow(sample.data) == 0) { next; }

			write(paste0('    ', smp, ':'), file = arguments$output, append = TRUE);

			# is this tumour or normal (may not apply to all projects)
			if ('R' == sample.data[1,]$Type) { type <- 'normal'; } else { type <- 'tumour'; }

			write(paste0('        type: ', type), file = arguments$output, append = TRUE);
			write('        libraries:', file = arguments$output, append = TRUE);

			for (lib in unique(df[which(df$Sample == smp),]$Library)) {

				lib.data <- droplevels(sample.data[which(sample.data$Library == lib),]);
				if (nrow(lib.data) == 0) { next; }

				write(paste0('            ', lib, ':'), file = arguments$output, append = TRUE);
				write('                runlanes:', file = arguments$output, append = TRUE);

				for (lane in unique(df[which(df$Library == lib),]$Lane)) {

					lane.data <- droplevels(lib.data[which(lib.data$Lane == lane),]);
					if (nrow(lane.data) == 0) { next; }

					write(paste0('                    ', lane, ':'), file = arguments$output, append = TRUE);
					write('                        fastq:', file = arguments$output, append = TRUE);

					write(paste0('                            R1: ', lane.data[1,]$R1), file = arguments$output, append = TRUE);
					write(paste0('                            R2: ', lane.data[1,]$R2), file = arguments$output, append = TRUE);
					}
				}
			}
		}

	# for BAMs
	} else {

	for (pat in unique(df$Patient)) {

		patient.data <- droplevels(df[which(df$Patient == pat),]);
		if (nrow(patient.data) == 0) { next; }

		write(paste0(pat,':'), file = arguments$output, append = TRUE);

		patient.data <- patient.data[order(patient.data$Type),];

		# does this patient have any tumour samples?
		if (any(patient.data$Type == 'tumour')) {

			write('    tumour:', file = arguments$output, append = TRUE);

			t.data <- droplevels(patient.data[which(patient.data$Type == 'tumour'),]);

			for (smp in unique(t.data$Sample)) {

				key <- paste0('        ', smp, ':');
				value <- t.data[which(t.data$Sample == smp),]$File;

				write(paste(key, value), file = arguments$output, append = TRUE);
				}
			}

		# does this patient have any normal samples?
		if (any(patient.data$Type == 'normal')) {

			write('    normal:', file = arguments$output, append = TRUE);

			n.data <- droplevels(patient.data[which(patient.data$Type == 'normal'),]);

			for (smp in unique(n.data$Sample)) {

				key <- paste0('        ', smp, ':');
				value <- n.data[which(n.data$Sample == smp),]$File;

				write(paste(key, value), file = arguments$output, append = TRUE);
				}
			}
		}
	}

