### collect_rsem_output.R ##########################################################################
# Finds and combines output generated by RSEM.

### FUNCTIONS ######################################################################################
# function to generate a standardized filename
generate.filename <- function(project.stem, file.core, extension, include.date = TRUE) {

	# build up the filename
	file.name <- paste(project.stem, file.core, sep = '_');
	file.name <- paste(file.name, extension, sep = '.');

	if (include.date) {
		file.name <- paste(Sys.Date(), file.name, sep = '_');
		}

	return(file.name);
	}

# function to write session profile to file
save.session.profile <- function(file.name) {

	# open the file
	sink(file = file.name, split = FALSE);

	# write memory usage to file
	cat('### MEMORY USAGE ###############################################################');
	print(proc.time());

	# write sessionInfo to file
	cat("\n### SESSION INFO ###############################################################");
	print(sessionInfo());

	# close the file
	sink();

	}

# function to identify symlinks
is.symlink <- function(file) {

	isTRUE(nzchar(Sys.readlink(file), keepNA = TRUE));

	}

### PREPARE SESSION ################################################################################
# import libraries
library(argparse);
library(plyr);

# import command line arguments
parser <- ArgumentParser();

parser$add_argument('-d', '--directory', type = 'character', help = 'path to data directory');
parser$add_argument('-p', '--project', type = 'character', help = 'project name');

arguments <- parser$parse_args();

# what's the date?
date <- Sys.Date();

setwd(arguments$directory);

### MAIN ###########################################################################################
# find results files
genes.files <- list.files(pattern = 'genes.results', recursive = TRUE);
isoforms.files <- list.files(pattern = 'isoforms.results', recursive = TRUE);

# filter out symlinks
genes.files <- genes.files[!sapply(genes.files, is.symlink)];
isoforms.files <- isoforms.files[!sapply(isoforms.files, is.symlink)];

# read them in
genes.list <- list();
isoforms.list <- list();

for (file in genes.files) {
	# extract sample ID
	smp <- unlist(strsplit(file, '\\/'))[3];
	# read in data
	tmp <- read.delim(file);
	# store data in list
	genes.list[[smp]] <- tmp[,c('gene_id', 'transcript_id.s.', 'TPM', 'FPKM')];
	colnames(genes.list[[smp]]) <- c('gene_id', 'transcript_id', paste0(smp, c('.TPM','.FPKM')));
	}

for (file in isoforms.files) {
	# extract sample ID
	smp <- unlist(strsplit(file, '\\/'))[3];
	# read in data
	tmp <- read.delim(file);
	# store
	isoforms.list[[smp]] <- tmp[,c('transcript_id', 'gene_id', 'TPM', 'FPKM')];
	colnames(isoforms.list[[smp]]) <- c('transcript_id', 'gene_id', paste0(smp, c('.TPM','.FPKM')));
	}

# reshape/format data
genes.formatted <- list();
isoforms.formatted <- list();

genes.tmp <- join_all(
	genes.list,
	by = c('gene_id','transcript_id'),
	type = 'full',
	match = 'first'
	);

isoforms.tmp <- join_all(
	isoforms.list,
	by = c('transcript_id','gene_id'),
	type = 'full',
	match = 'first'
	);

genes.formatted$fpkm <- genes.tmp[,c(1,2, grep('FPKM', colnames(genes.tmp)))];
genes.formatted$tpm  <- genes.tmp[,c(1,2, grep('TPM', colnames(genes.tmp)))];

colnames(genes.formatted$fpkm) <- gsub('.FPKM', '', colnames(genes.formatted$fpkm));
colnames(genes.formatted$tpm)  <- gsub('.TPM', '', colnames(genes.formatted$tpm));

isoforms.formatted$fpkm <- isoforms.tmp[,c(1,2, grep('FPKM', colnames(isoforms.tmp)))];
isoforms.formatted$tpm  <- isoforms.tmp[,c(1,2, grep('TPM', colnames(isoforms.tmp)))];

colnames(isoforms.formatted$fpkm) <- gsub('.FPKM', '', colnames(isoforms.formatted$fpkm));
colnames(isoforms.formatted$tpm)  <- gsub('.TPM', '', colnames(isoforms.formatted$tpm));

# save combined/formatted data to file
write.table(
	genes.formatted$fpkm,
	file = generate.filename(arguments$project, 'gene_expression_FPKM','tsv'),
	row.names = FALSE,
	col.names = TRUE,
	sep = '\t'
	);

write.table(
	genes.formatted$tpm,
	file = generate.filename(arguments$project, 'gene_expression_TPM','tsv'),
	row.names = FALSE,
	col.names = TRUE,
	sep = '\t'
	);

# save combined/formatted data to file
write.table(
	isoforms.formatted$fpkm,
	file = generate.filename(arguments$project, 'isoform_expression_FPKM','tsv'),
	row.names = FALSE,
	col.names = TRUE,
	sep = '\t'
	);

write.table(
	isoforms.formatted$tpm,
	file = generate.filename(arguments$project, 'isoform_expression_TPM','tsv'),
	row.names = FALSE,
	col.names = TRUE,
	sep = '\t'
	);

### SAVE SESSION INFO ##############################################################################
save.session.profile(generate.filename('CollectRSEM','SessionProfile','txt'));
