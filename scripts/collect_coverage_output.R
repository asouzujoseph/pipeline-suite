### collect_coverage_output.R ######################################################################
# Finds and combines output generated by DepthOfCoverage

### FUNCTIONS ######################################################################################
# function to generate a standardized filename
generate.filename <- function(project.stem, file.core, extension, include.date = TRUE) {

	# build up the filename
	file.name <- paste(project.stem, file.core, sep = '_');
	file.name <- paste(file.name, extension, sep = '.');

	if (include.date) {
		file.name <- paste(Sys.Date(), file.name, sep = '_');
		}

	return(file.name);
	}

# function to write session profile to file
save.session.profile <- function(file.name) {

	# open the file
	sink(file = file.name, split = FALSE);

	# write memory usage to file
	cat('### MEMORY USAGE ###############################################################');
	print(proc.time());

	# write sessionInfo to file
	cat("\n### SESSION INFO ###############################################################");
	print(sessionInfo());

	# close the file
	sink();

	}

### PREPARE SESSION ################################################################################
# import libraries
library(argparse);

# import command line arguments
parser <- ArgumentParser();

parser$add_argument('-d', '--directory', type = 'character', help = 'path to data directory');
parser$add_argument('-p', '--project', type = 'character', help = 'project name');

arguments <- parser$parse_args();

# what's the date?
date <- Sys.Date();

setwd(arguments$directory);

### MAIN ###########################################################################################
# find results files
cov.files <- list.files(pattern = 'DepthOfCoverage.sample_statistics$', recursive = TRUE);
summary.files <- list.files(pattern = 'DepthOfCoverage.sample_summary$', recursive = TRUE);
interval.files <- list.files(pattern = 'DepthOfCoverage.sample_interval_summary$', recursive = TRUE);

# read them in
cov.list <- list();
summary.list <- list();
interval.list <- list();

for (file in cov.files) {
	# extract sample ID
	smp <- sub('_DepthOfCoverage.sample_statistics','',basename(file));
	# store data in list
	cov.list[[smp]] <- read.delim(file);
	}

for (file in summary.files) {
	# extract sample ID
	smp <- sub('_DepthOfCoverage.sample_summary','',basename(file)); 
	# store data in list
	summary.list[[smp]] <- read.delim(file)[1,];
	}

for (file in interval.files) {
	# extract sample ID
	smp <- sub('_DepthOfCoverage.sample_interval_summary','',basename(file)); 
	# store data in list
	tmp <- read.delim(file)[,c('Target','average_coverage')];
	tmp$Sample <- smp;
	interval.list[[smp]] <- tmp;
	}

# reshape/format data
cov.data <- do.call(rbind, cov.list);
cov.data <- data.frame(t(cov.data[,-1]));
cov.data$Coverage <- sapply(rownames(cov.data), function(i) { unlist(strsplit(i,'_'))[2] });

summary.data <- do.call(rbind, summary.list)[,-1];
colnames(summary.data)[6] <- sub('X.', 'percent', colnames(summary.data)[6]);

# save data to file
write.table(
	cov.data,
	file = generate.filename(arguments$project, 'Coverage_statistics','tsv'),
	row.names = TRUE,
	col.names = NA,
	sep = '\t'
	);

write.table(
	summary.data,
	file = generate.filename(arguments$project, 'Coverage_summary','tsv'),
	row.names = TRUE,
	col.names = NA,
	sep = '\t'
	);

if (length(interval.files) > 0) {
	interval.data <- reshape(
		do.call(rbind, interval.list),
		direction = 'wide',
		idvar = 'Target',
		timevar = 'Sample'
		);
	colnames(interval.data) <- gsub('average_coverage.','',colnames(interval.data));

	write.table(
		interval.data,
		file = generate.filename(arguments$project, 'interval_coverage','tsv'),
		row.names = FALSE,
		col.names = TRUE,
		sep = '\t'
		);
	}

### SAVE SESSION INFO ##############################################################################
save.session.profile(generate.filename('CollectCoverage','SessionProfile','txt'));
