### collect_contest_output.R #######################################################################
# Finds and combines output generated by ContEst

### FUNCTIONS ######################################################################################
# function to generate a standardized filename
generate.filename <- function(project.stem, file.core, extension, include.date = TRUE) {

	# build up the filename
	file.name <- paste(project.stem, file.core, sep = '_');
	file.name <- paste(file.name, extension, sep = '.');

	if (include.date) {
		file.name <- paste(Sys.Date(), file.name, sep = '_');
		}

	return(file.name);
	}

# function to write session profile to file
save.session.profile <- function(file.name) {

	# open the file
	sink(file = file.name, split = FALSE);

	# write memory usage to file
	cat('### MEMORY USAGE ###############################################################');
	print(proc.time());

	# write sessionInfo to file
	cat("\n### SESSION INFO ###############################################################");
	print(sessionInfo());

	# close the file
	sink();

	}

### PREPARE SESSION ################################################################################
# import libraries
library(argparse);

# import command line arguments
parser <- ArgumentParser();

parser$add_argument('-d', '--directory', type = 'character', help = 'path to data directory');
parser$add_argument('-p', '--project', type = 'character', help = 'project name');

arguments <- parser$parse_args();

# what's the date?
date <- Sys.Date();

setwd(arguments$directory);

### MAIN ###########################################################################################
# find results files
meta.files <- list.files(pattern = 'META.tsv$', recursive = TRUE);
lane.files <- list.files(pattern = 'READGROUP.tsv$', recursive = TRUE);

# read them in
all.samples <- c();
meta.list <- list();
lane.list <- list();

for (file in meta.files) {
	# extract sample ID
	smp <- sub('_ContEst_META.tsv','',basename(file));
	all.samples <- c(all.samples, smp);
	# attempt to read in results
	data <- tryCatch(expr = read.delim(file, stringsAsFactors = FALSE), error = function(e) { return(NULL) });
	# store data in list
	if (!is.null(data)) { meta.list[[smp]] <- data; }
	}

for (file in lane.files) {
	# extract sample ID
	smp <- sub('_ContEst_READGROUP.tsv','',basename(file));
	# attempt to read in results
	data <- tryCatch(expr = read.delim(file, stringsAsFactors = FALSE), error = function(e) { return(NULL) });
	# store data in list
	if (!is.null(data)) { lane.list[[smp]] <- data; }
	}

# reshape/format data
meta.data <- do.call(rbind, meta.list);
lane.data <- do.call(rbind, lane.list);

# add in any missing samples
missing.smps <- setdiff(all.samples, rownames(meta.data));
if (length(missing.smps) > 0) {
	meta.data[missing.smps,] <- NA;
	meta.data[is.na(meta.data$name),]$name <- 'META';
	}

missing.smps <- setdiff(all.samples, sapply(rownames(lane.data), function(i) { unlist(strsplit(i, '\\.'))[1] }));
if (length(missing.smps) > 0) {
	lane.data[missing.smps,] <- NA;
	lane.data[is.na(lane.data$name),]$name <- 'LANE';
	}

# format data
meta.data$Sample <- rownames(meta.data);
lane.data$Sample <- sapply(rownames(lane.data), function(i) { unlist(strsplit(as.character(i),'\\.'))[1] } );

# combine for writing
formatted.data <- rbind(meta.data, lane.data);
formatted.data <- formatted.data[,c('Sample',colnames(meta.list[[1]]))];

# save combined/formatted data to file
write.table(
	formatted.data,
	file = generate.filename(arguments$project, 'ContEst_output','tsv'),
	row.names = FALSE,
	col.names = TRUE,
	sep = '\t'
	);

### SAVE SESSION INFO ##############################################################################
save.session.profile(generate.filename('CollectContEst','SessionProfile','txt'));
